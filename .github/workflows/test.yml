name: test

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PYTEST_ADDOPTS: "--color=yes"

permissions: {}

jobs:
  package:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false
      - name: Build and Check Package
        uses: hynek/build-and-inspect-python-package@c52c3a4710070b50470d903818a7b25115dcd076

  build:
    needs: [package]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    permissions:
      contents: read

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "ubuntu-py312"
            python: "3.12"
            os: ubuntu-latest
            tox_env: "py312"
            use_coverage: true

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download Package
        uses: actions/download-artifact@v5
        with:
          name: Packages
          path: dist

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python }}
          check-latest: true
          allow-prereleases: true

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install tox pytest coverage setuptools hypothesis attrs xmlschema

      - name: Test without coverage
        if: "! matrix.use_coverage"
        shell: bash
        run: tox run -e ${{ matrix.tox_env }} --installpkg `find dist/*.tar.gz`

      - name: Test with coverage
        if: "matrix.use_coverage"
        shell: bash
        run: tox run -e ${{ matrix.tox_env }}-coverage --installpkg `find dist/*.tar.gz`

      - name: Generate coverage report
        if: "matrix.use_coverage"
        run: python -m coverage xml

      - name: Upload coverage to Codecov
        if: "matrix.use_coverage"
        uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7
        with:
          fail_ci_if_error: false
          files: ./coverage.xml
          verbose: true

  test-with-testmon:
    needs: [package]
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - name: "ubuntu-py312"
            python: "3.12"
            os: ubuntu-latest
            tox_env: "py312"
            use_coverage: true

    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Download Package
        uses: actions/download-artifact@v5
        with:
          name: Packages
          path: dist

      - name: Set up Python ${{ matrix.python }}
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python }}
          check-latest: true
          allow-prereleases: true

      - name: Restore .testmondata cache
        uses: actions/cache@v4
        with:
          path: .testmondata
          key: testmon-${{ github.ref_name }}
          restore-keys: |
            testmon-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest-testmon setuptools hypothesis attrs xmlschema

      - name: First run (full, builds testmon cache)
        run: |
          pip install -e .  # installs your package in editable mode
          time pytest --testmon

      - name: Save testmon cache
        uses: actions/cache/save@v4
        with:
          path: .testmondata
          key: testmon-${{ github.ref_name }}-${{ github.run_id }}

      - name: Second run (incremental)
        run: |
          echo "Running incremental testmon pass"
          time pytest --testmon
